<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AVL Tree Visualizer</title>

    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <style>
        #svgWrap{
            margin: 0;
            padding: 0;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        #mainSvg {
            width: 90vw;
            height: 80vh;
            overflow: visible;
        }
    </style>
</head>

<body>
    <h1>AVL Tree Visualizer</h1>
    <div>
        <input type="text" id="insert"/>
        <button id="insertButton">
            Insert
        </button>

        <input type="text" id="delete"/>
        <button id="deleteButton">
            Delete
        </button>

        <input type="text" id="find"/>
        <button id="findButton">
            Find
        </button>

        <button id="clearButton">
            Clear
        </button>

        <button id="randomButton">
            Random Tree
        </button>
    </div>
    <div id="svgWrap">
        <svg id="mainSvg" width="600px" height="400px">

        </svg>
    </div>
    

    <script>
        //https://stackoverflow.com/questions/3642035/jquerys-append-not-working-with-svg-element <-- Source for svg making stuff
        function addShape(tag, attrs){
            var el= document.createElementNS('http://www.w3.org/2000/svg', tag);
            for (var k in attrs)
                el.setAttribute(k, attrs[k]);
            document.getElementById('mainSvg').appendChild(el);
        }

        function addText(text, attrs){
            var el= document.createElementNS('http://www.w3.org/2000/svg', "text");
            for (var k in attrs)
                el.setAttribute(k, attrs[k]);
            
            el.textContent = text;

            document.getElementById('mainSvg').appendChild(el);
        }

        const nodeRadius = 40;
        var root = null;
        const nodes = [];

        function addNode(value, x, y){
            addShape("circle", {cx:x, cy:y, r:nodeRadius, stroke:"black", "stroke-width":5, fill:"white", id:"myCircle"});
            addText(value, {x:x, y:y, "text-anchor":"middle", "dominant-baseline":"middle", "font-family":"monospace", "font-size":"24", "fill":"black"})
        }

        $(document).ready(function() {
            $("#insertButton").click(function() {
                var w = $("#mainSvg").width();
                var h = $("#mainSvg").height();
                //addNode(5, w/2, 0);

                var value = $("#insert").val();
                value = parseInt(value, 10);
                const n = new Node(value);
                if(root == null){
                    console.log("Adding new node at the root");
                    root = n;
                }else{
                    root.insert(n, []);
                }
                $("#insert").val('');
            });

            $("#deleteButton").click(function(){
                var value = $("#delete").val();
                value = parseInt(value, 10);
                if(root != null){
                    root.delete(value,[]);
                }
                $("#delete").val('');
            });

            $("#findButton").click(function(){
                alert("Find clicked!");
            });

            $("#clearButton").click(function(){
                alert("Clear clicked!");
            });

            $("#randomButton").click(function(){
                
                //temporary, displays all the nodes
                if(root != null)
                    root.display();
            });
        });

        class Node {
            constructor(value){
                this.value = value;
                this.left = null;
                this.right = null;
            }

            getValue(){
                return this.value;
            }

            getHeight(){
                var l = -1;
                var r = -1;
                if(this.left != null)
                    l = this.left.getHeight();
                if(this.right != null)
                    r = this.right.getHeight();
                if(l > r){
                    return l + 1;
                }else{
                    return r + 1;
                }
            }

            isValid(){
                var l = -1;
                var r = -1;
                if(this.left != null)
                    l = this.left.getHeight();
                if(this.right != null)
                    r = this.right.getHeight();

                if(Math.abs(l - r) <= 1){
                    return true
                }else{
                    return false
                }
            }

            insert(n, path){
                path.unshift(this);
                if(n.value <= this.value){
                    if(this.left == null){
                        console.log("Inserted " + n.value + " as a left child of " + this.value);
                        path.unshift(n);
                        console.log(path);
                        this.left = n;

                        //check for validity
                        for(var i = 0; i < path.length; i++){
                            console.log(path[i].value + ":" + path[i].isValid());
                            if(!path[i].isValid()){
                                fixViolation(path[i], path[i-1], path[i-2]);
                            }
                        }
                    }else{
                        this.left.insert(n, path);
                    }
                }else{
                    if(this.right == null){
                        console.log("Inserted " + n.value + " as a right child of " + this.value);
                        path.unshift(n);
                        console.log(path);
                        this.right = n;

                        //check for validity
                        for(var i = 0; i < path.length; i++){
                            console.log(path[i].value + ":" + path[i].isValid());
                            if(!path[i].isValid()){
                                fixViolation(path[i], path[i-1], path[i-2]);
                            }
                        }
                    }else{
                        this.right.insert(n, path);
                    }
                }
            }

            //assumes a leaf node is being deleted, need to improve
            //if deleted node has left children replace with largest left
            //if no left replace with immediate right (or null if that is null)
            //including the newly replaced node, check along the path for violations
            delete(value, path){
                path.unshift(this);
                if(value <= this.value){
                    if(this.left == null){
                        console.log("Could not delete " + value + " no such node");
                    }else{
                        if(this.left.value == value){
                            this.left = null;
                            for(var i = 0; i < path.length; i++){
                                console.log(path[i].value + ":" + path[i].isValid());
                                if(!path[i].isValid()){
                                    var k1 = path[i];
                                    //get k2
                                    if(k1 === this || k1.left === path[i-1]){
                                        var k2 = k1.right;
                                    }else{
                                        var k2 = k1.left;
                                    }
                                    //get k3
                                    var k2l = -1;
                                    var k2r = -1;
                                    if(k2.left != null)
                                        k2l = k2.left.getHeight();
                                    if(k2.right != null)
                                        k2r = k2.right.getHeight();
                                    
                                    if(k2r >= k2l){
                                        var k3 = k2.right;
                                    }else{
                                        var k3 = k2.left;
                                    }
                                    fixViolation(k1,k2,k3);
                                }
                            }
                        }else{
                            this.left.delete(value,path);
                        }
                    }
                }else{
                    //value on right side
                    if(this.right == null){
                        console.log("Could not delete " + value + " no such node");
                    }else{
                        if(this.right.value == value){
                            this.right = null;
                            for(var i = 0; i < path.length; i++){
                            console.log(path[i].value + ":" + path[i].isValid());
                            if(!path[i].isValid()){
                                var k1 = path[i];
                                //get k2
                                if(k1.left === path[i-1]){
                                    var k2 = k1.right;
                                }else{
                                    var k2 = k1.left;
                                }
                                //get k3
                                var k2l = -1;
                                var k2r = -1;
                                if(k2.left != null)
                                    k2l = k2.left.getHeight();
                                if(k2.right != null)
                                    k2r = k2.right.getHeight();
                                
                                if(k2r >= k2l){
                                    var k3 = k2.right;
                                }else{
                                    var k3 = k2.left;
                                }
                                fixViolation(k1,k2,k3);
                            }
                        }
                        }else{
                            this.right.delete(value,path);
                        }
                    }
                }
            }

            display(){
                var v1 = this.value;
                var v2 = "null";
                var v3 = "null";

                if(this.left != null)
                    v2 = this.left.value;
                if(this.right != null)
                    v3 = this.right.value;

                console.log(v1 + ":" + v2 + "," + v3);
                if(this.left != null)
                    this.left.display();
                if(this.right != null)
                    this.right.display();
            }
        }

        function fixViolation(k1, k2, k3){
            console.log(k1, k2, k3);
            //find the relationship between k1 and k2
            var firstIsRight = (k1.right === k2);
            var secondIsRight = (k2.right === k3);
            
            if(firstIsRight && secondIsRight){
                //Right right rotation
                console.log("RR rotation");
                temp = k2.left;
                k2.left = k1;
                k1.right = temp;
                if(root === k1)
                    root = k2;
                k2.display();
            }else if(firstIsRight && !secondIsRight){
                //Right left rotation
                console.log("RL rotation");
                temp1 = k3.left;
                temp2 = k3.right;
                k3.left = k1;
                k3.right = k2;
                k1.right = temp1;
                k2.left = temp2;
                if(root === k1)
                    root = k3;
                k3.display();
            }else if(!firstIsRight && secondIsRight){
                //Left Right rotation
                console.log("LR rotation");
                temp1 = k3.left;
                temp2 = k3.right;
                k3.right = k1;
                k3.left = k2;
                k2.right = temp1;
                k1.left = temp2;
                if(root === k1)
                    root = k3;
                k3.display();
            }else{
                //Left left rotation
                console.log("LL rotation");
                temp = k2.right;
                k2.right = k1;
                k1.left = temp;
                if(root === k1)
                    root = k2;
                k2.display();
            }
        }

    </script>
</body>
</html>
